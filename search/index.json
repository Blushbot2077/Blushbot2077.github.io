[{"content":"你是猪吗? 你是猪! 你是不是猪!\n","date":"2023-06-20","permalink":"https://blushbot.ppfarm.boats/post/computonal_mechanism/","tags":null,"title":"Computional mechanism"},{"content":"Convert, FieldMap , 以及Preproceesing\nConvert DICOM - NIfTI 两种方法: SPM12 DICOM import 和 MRIcroGL(dcm2niix)\n直接使用 SPM12 转换非常简单，但缺点是无法看到 DICOM 文件的原始数据（比如TR，TE），可能会对 Fieldmap 校正选择参数带来一些困难。而使用 MRIcroGL 则可以额外生成保留原数据的 json 文件。因此这里主要说明 MRIcroGL 的操作方法。\nMRIcroGL is also used for visualizing imaging data, especially group-level results. 但目前只用来转换成 NIfTI 文件.\n以下内容参考了Andysbrainbook.\n安装 MRIcroGL 安装后进入软件,菜单栏选中import-\u0026gt;Convert DICOM to NIfTI,会看到如下界面:\nOutput Filename：默认是格式化运算符%f_%p_%t_%s,鼠标停留在名称上会有每个变量的具体说明,可以根据需要修改转换后输出的名称。\nOutput Derictiory：输出路径，默认与DICOM文件在同一个文件夹。\nOutput Format：输出格式，默认是compressed NIfTI. 但请注意,SPM无法打开压缩的文件（AFNI和FSL都可以打开），建议手动选择uncompressed NIFTI。\nCreate BIDS Sidecar：该选项会创建一个包含原DICOM数据的Javascript Object Notation (.json)文件，包括slice-timing, slice order, the repetition time, echo time 等等。其中，Echo time 是 Fieldmap 时很重要的一个参数。\nConverting the DICOM Files using MRIcroGL 可以通过鼠标拖拽或者Select Folder to Convert 按钮选择想要转换的DICOM文件夹，右侧窗口会显示转换完成。\nRunning DICOM to NIFTI from the Command Line （还没使用过）\nFieldMap 校正 FieldMap 校正是指，对成像进行动态或静态的畸变校正。\nSPM12 中使用 Fieldmap toolbox 进行 Fieldmap 校正。\n两个步骤：\nCalculate，计算 VDM（voxel displacement map） Apply，使用 VDM 对成像进行校正 几个我用到的关键参数：\nCalculate VDM. Echo time：需要手动输入 Magnitude Image 和 Phase Image 的 short TE 和 long TE。(i.e.,[4.92 7.38])\nMagnitude Image: 有多个时选择 TE 更小的，有更好的信号强度。\nPhase Image：信号和radiofrequency pulse的相位。\nMask brain: 选择是否 mask brain。如果选择 masking，Magnitude Image 会用来生成一个 brain mask。\nBlip direction：相位编码方向与 Y 方向（从后脑勺往前额）的关系。+ve 为1，-ve 为-1。\nEPI-based filed map: 是否基于 EPI 获得的 Fieldmap，基于 EPI 的fieldmap 相当于是在扭曲的空间里获得了场图，因此生成 VDM 将会被调整。\nuflags: phase unwrapping 和 field map 处理的不同选项。加权平滑。\nmflags：segmentation 和创建 brain mask 的不同选项。使用 T1 对变形的 EPI 进行校正。\nVDM filename extension：生成的 VDM 文件的前缀，s。\nWrite unwarped EPI?: 导出校正后的 EPI，前缀是 u。(仅用来quality control of correction)\n计算 VDM 需要 MI 和 PI 这两个参数\nApply VDM. images:需要进行场图校正的 EPI。【代码写法】\nField map (vdm*file):需要应用的VDM，一个以vdm开头的文件。\nP.S. 所有过程都可以以 batch code 方式批量操作。\n校正后的EPI文件的前缀是wu，表示\u0026quot;warped and unwarped\u0026quot;。\n校正后的EPI文件保存在与输入EPI图像相同的路径下。\nRealignment 运动校正，修正EPI的位移\nRealign \u0026amp; Unwarp（运动校正和磁场畸变校正）\nUnwarp 和 Field map\n都是用于磁场畸变校正的方法，但具有不同的原理和实施步骤，具体根据实验的需要选用。\nUnwarp（畸变校正）：Unwarp方法是基于图像处理的技术，通过图像重采样和插值来校正图像畸变。它依赖于相邻时间点的fMRI图像信息。Unwarp方法通常需要额外的参考数据（例如，额外的fMRI序列）来估计磁场畸变的模型。\nField Map（场图法）：Field map方法是基于磁场测量的技术，通过测量磁场变化来估计和校正磁场畸变。它依赖于额外的磁场映射扫描数据。\nCoregistration 将T1登陆到EPI(变换、计算处理) 有三种变换方式:Affine(平移+旋转的刚体变换),Stretching(保持一个方向不变移动其他方向),Shearing(扩大+缩小变形)\nEstimate：estimate用于估计将源图像（EPI）与参考图像（T1）对齐所需的变换参数。这些变换参数描述了源图像与参考图像之间的平移（translation）和旋转（rotation）关系，以使它们在相同的坐标空间中对齐。estimate步骤不会对图像进行重采样。\nReslice：reslice用于根据先前估计的变换参数对源图像 EPI 进行重采样，以使其与参考图像 T1 在空间上对齐。通过重采样，源图像 EPI 的像素将根据变换参数重新分布和插值，使其与参考图像 T1 的空间坐标一致。在后续分析时，EPI 与 T1 就可以在相同的空间坐标系下进行对应。\nEstimate \u0026amp; Reslice：estimate \u0026amp; reslice 是将上述两个步骤合并为一个步骤的选项。一次性完成 estimate 和 reslice。\nSegmentation 将T1分解为标准脑6要素,分割后称为TPM\nNormalisation EPI标准化\n为了把 Coregistration 过后的图像和 MNI 标准脑 TPM 重合而进行计算\nSmoothing EPI空间平滑化\n通过应用高斯滤波器，对fMRI图像进行空间平滑处理。平滑处理有助于减少噪声和局部变异，提高信号与噪声的比值，并提升数据的统计可靠性。\n空间上幅的表示方法:半值全幅(FWHM,Full Width at Half Maximum)\n半值全幅(FWHM),指从 peak 开始高度一半地方的宽度. FWHM的值一般是voxel的2-3倍,不过在评价杏仁核这样的小结构时,也用1.5倍这样的小数值. FWHM越大,整体的功能画像就会越模糊(因为FWHM越大,意味着图像和平均的相邻voxel相关度变高).\nReference SPM12 Manual\nSPM 中文初学者指南\n","date":"2023-06-20","permalink":"https://blushbot.ppfarm.boats/post/preprocessing/","tags":["SPM12学习笔记"],"title":"fMRI脑成像预处理(SPM12 Preprocessing)"}]